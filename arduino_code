#include <Stepper.h>
#include <Arduino_Thread.h>

Thread pumpThread;
Thread turbineThread;
Thread nodventilThread;

String command;

const int trigPin = 5;
const int echoPin = 4;
const int stepperPin = 3;
const int pumpPin = 2;


float duration;
float distance;
float reference = 15;

const float STEPS_PER_REV = 32;
const float GEAR_RED = 64;
const float STEPS_PER_OUT_REV = STEPS_PER_REV * GEAR_RED;

int StepsRequired;

Stepper steppermotor_1(STEPS_PER_REV, 10, 12, 11 ,13);
Stepper steppermotor_2(STEPS_PER_REV, 6, 8, 7 ,9);

volatile bool stopmotors = false;

void readDistance() {
	while (true) {
		digitalWrite(trigPin, LOW);
		delayMicroseconds(2);
		digitalWrite(trigPin, HIGH);
		delayMicroseconds(10);
		digitalWrite(trigPin, LOW);
		duration = pulseIn(echoPin, HIGH);
		distance = (duration * 0.034 / 2);
		Serial.println(distance);
		delay(1000);
	}
}


void pump() {
	while (!stopmotors) {
		digitalWrite(pumpPin, HIGH);
	}
	digitalWrite(pumpPin, LOW);
}

void turbine() {
	while (!stopmotors) {
		digitalWrite(stepperPin, HIGH);
		steppermotor_1.step(StepsRequired);
	}
	steppermotor_1.step(-StepsRequired);
	digitalWrite(stepperPin, LOW);
}

void nodventil() {
	while (!stopmotors) {
		digitalWrite(stepperPin, HIGH);
		steppermotor_2.step(StepsRequired);
	}
	steppermotor_2.step(-StepsRequired);
	digitalWrite(stepperPin, LOW);
}


void init_threads() {
  pumpThread.onRun(pump);
  turbineThread.onRun(turbine);
  nodventilThread.onRun(nodventil);
  
  pumpThread.setInterval(1);
  turbineThread.setInterval(1);
  nodventilThread.setInterval(1);
  
  //pumpThread.setPriority(2);
  //turbineThread.setPriority(1);
  //nodventilThread.setPriority(1);
  
  pumpThread.onCleanup([](){ stopmotors = true; });
  turbineThread.onCleanup([](){ stopmotors = true; });
}


void run_threads() {
  while (!stopmotors) {
    pumpThread.run();
    turbineThread.run();
    nodventilThread.run();
  }
}

void loop() {
  run_threads();
}


void setup() {
  Serial.begin(9600);
  pinMode(trigPin, OUTPUT); 
  pinMode(echoPin, INPUT); 
  pinMode(pumpPin,OUTPUT); 
  pinMode (stepperPin, OUTPUT);

  readDistance();
  Mutex stopMutex;

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\n');
    if (command == "Pump\n") {
      stopMutex.lock();
      stopmotors = false;
      stopMutex.unlock();
      pumpThread.resume();
      turbineThread.pause();
      nodventilThread.pause();
    } else if (command == "Turbine\n") {
      stopMutex.lock();
      stopmotors = false;
      stopMutex.unlock();
      pumpThread.pause();
      turbineThread.resume();
      nodventilThread.pause();
    } else if (command == "Nodventil\n") {
      stopMutex.lock();
      stopmotors = false;
      stopMutex.unlock();
      pumpThread.pause();
      turbineThread.pause();
      nodventilThread.resume();
    } else if (command == "Stopp\n") {
      stopMutex.lock();
      stopmotors = true;
      stopMutex.unlock();
      pumpThread.pause();
      turbineThread.pause();
      nodventilThread.pause();
    }
  }
}
